<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SkillVault — Monad Testnet</title>

<!-- Ethers v6 -->
<script src="https://cdn.jsdelivr.net/npm/ethers@6.10.0/dist/ethers.min.js"></script>
<!-- Tailwind for quick styles -->
<script src="https://cdn.tailwindcss.com"></script>
<!-- Your ABI file (must expose window.SKILLVAULT_ABI) -->
<script src="./abi.js"></script>

<style>
  :root {
    --bg: #050505;
    --card: #0f1113;
    --muted: #9aa4ad;
    --accent: #00ffd0;
    --accent-dark: #1effe0;
  }
  body { background: radial-gradient(circle at 10% 20%, #000, #071018); color: #e6eef0; font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; }
  .card { background: var(--card); border: 1px solid rgba(255,255,255,0.03); border-radius: 12px; padding: 18px; }
  .btn { background: var(--accent); color: #000; font-weight: 700; border-radius: 8px; padding: 8px 14px; }
  .btn:hover { background: var(--accent-dark); }
  .muted { color: var(--muted); }
  #status { font-size: .95rem; padding: 8px 12px; border-radius: 8px; background: rgba(255,255,255,0.02); }
  .file-drop { border: 2px dashed rgba(255,255,255,0.04); border-radius: 8px; padding: 12px; display:flex; gap:12px; align-items:center; }
  img.pfp { width:56px; height:56px; border-radius:999px; object-fit:cover; border:2px solid rgba(255,255,255,0.04); }
  .small { font-size: .9rem; }
</style>
</head>
<body class="min-h-screen flex items-start justify-center p-6">

<div class="w-full max-w-4xl space-y-6">
  <header class="flex items-center justify-between">
    <div>
      <h1 class="text-2xl font-bold" style="color:var(--accent)">SkillVault</h1>
      <div id="status" class="mt-2 muted">Ready — connect wallet (Monad Testnet)</div>
    </div>

    <div class="flex gap-3 items-center">
      <input id="contractAddressInput" class="p-2 rounded-lg bg-[#061018] border border-gray-700 small" style="width:320px" value="" placeholder="Enter contract address or paste here" />
      <button id="setContractBtn" class="btn">Set Contract</button>
      <button id="connectBtn" class="btn">Connect Wallet</button>
    </div>
  </header>

  <!-- Top visible controls -->
  <div class="card">
    <div class="flex items-center justify-between">
      <div>
        <div class="muted small">Network</div>
        <div id="networkLabel" class="font-semibold">Monad Testnet (10143)</div>
      </div>

      <div>
        <div class="muted small">Contract</div>
        <div id="contractLabel" class="font-semibold">Not set</div>
      </div>
    </div>
  </div>

  <!-- Profile & PFP -->
  <section id="profileCard" class="card hidden space-y-4">
    <div class="flex items-center justify-between">
      <div>
        <h2 class="text-lg font-semibold">Your Profile</h2>
        <div id="profileSmall" class="muted small">Connect and load profile</div>
      </div>
      <div class="flex items-center gap-4">
        <img id="pfpPreview" class="pfp hidden" alt="pfp" />
        <div id="addressBadge" class="muted small"></div>
      </div>
    </div>

    <div>
      <label class="block muted small mb-2">Upload / drag & drop a PFP (optional)</label>
      <div id="fileDrop" class="file-drop" >
        <input id="pfpFile" type="file" accept="image/*" class="hidden" />
        <div id="fileDropText" class="muted small">Drag & drop image here, or <button id="chooseFileBtn" class="btn small">Choose file</button></div>
        <div id="uploadProgress" class="muted small ml-auto hidden">Uploading…</div>
      </div>
    </div>

    <div class="flex gap-3">
      <button id="createProfileBtn" class="btn">Create / Update Profile</button>
      <button id="refreshProfileBtn" class="btn">Refresh Profile</button>
    </div>

    <div id="profileDetails" class="muted small"></div>
  </section>

  <!-- Your Skills -->
  <section id="skillsCard" class="card hidden">
    <div class="flex items-center justify-between">
      <h2 class="text-lg font-semibold">Your Skills</h2>
      <div>
        <button id="addSkillBtn" class="btn">Add New Skill</button>
      </div>
    </div>

    <div id="skillsList" class="mt-4 space-y-3 muted small">No skills loaded.</div>
  </section>

  <!-- Builder lookup & endorsements -->
  <section class="card">
    <h2 class="text-lg font-semibold">Endorse a Builder</h2>
    <div class="mt-3 flex gap-3">
      <input id="builderAddress" placeholder="0x..." class="p-2 rounded-lg bg-[#061018] border border-gray-700 w-full" />
      <button id="loadBuilderBtn" class="btn">Load</button>
      <button id="clearBuilderBtn" class="btn">Clear</button>
    </div>

    <div id="builderSkillsList" class="mt-4 space-y-3 muted small"></div>
  </section>

</div>

<script>
/* ========= CONFIG ========= */
const DEFAULT_CONTRACT_ADDRESS = "0x38238FBf2d6D515Af42ee17452b87cDBFc517aD1"; // paste default deployed contract if desired
const MONAD_CHAIN_ID = "0x279f";     // 10143 hex
const MONAD_RPC = "https://testnet-rpc.monad.xyz";

/* ========= STATE ========= */
let provider, signer, signerAddress;
let contract = null;
let contractAddress = DEFAULT_CONTRACT_ADDRESS || "";
let abi = window.SKILLVAULT_ABI || null;

/* ========= DOM ========= */
const statusEl = document.getElementById('status');
const connectBtn = document.getElementById('connectBtn');
const setContractBtn = document.getElementById('setContractBtn');
const contractAddressInput = document.getElementById('contractAddressInput');
const contractLabel = document.getElementById('contractLabel');
const networkLabel = document.getElementById('networkLabel');

const profileCard = document.getElementById('profileCard');
const profileDetails = document.getElementById('profileDetails');
const profileSmall = document.getElementById('profileSmall');
const addressBadge = document.getElementById('addressBadge');
const pfpPreview = document.getElementById('pfpPreview');

const fileDrop = document.getElementById('fileDrop');
const pfpfInput = document.getElementById('pfpFile');
const chooseFileBtn = document.getElementById('chooseFileBtn');
const uploadProgress = document.getElementById('uploadProgress');

const createProfileBtn = document.getElementById('createProfileBtn');
const refreshProfileBtn = document.getElementById('refreshProfileBtn');

const skillsCard = document.getElementById('skillsCard');
const skillsList = document.getElementById('skillsList');
const addSkillBtn = document.getElementById('addSkillBtn');

const builderAddressInput = document.getElementById('builderAddress');
const loadBuilderBtn = document.getElementById('loadBuilderBtn');
const clearBuilderBtn = document.getElementById('clearBuilderBtn');
const builderSkillsList = document.getElementById('builderSkillsList');

/* ========= UTILS ========= */
function setStatus(text, level = 'info') {
  statusEl.textContent = text;
  statusEl.className = '';
  if (level === 'error') statusEl.classList.add('text-red-400');
  else if (level === 'success') statusEl.classList.add('text-green-300');
  else statusEl.classList.add('muted');
}

async function ensureMonadNetwork() {
  if (!window.ethereum) { setStatus('No injected wallet (MetaMask).', 'error'); return false; }
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: MONAD_CHAIN_ID }] });
    return true;
  } catch (err) {
    if (err?.code === 4902) {
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: MONAD_CHAIN_ID,
            chainName: 'Monad Testnet',
            nativeCurrency: { name: 'MON', symbol: 'MON', decimals: 18 },
            rpcUrls: [MONAD_RPC],
            blockExplorerUrls: ['https://explorer.monad.xyz/']
          }]
        });
        return true;
      } catch (addErr) {
        console.error('add chain failed', addErr);
        setStatus('Failed to add Monad Testnet to wallet.', 'error');
        return false;
      }
    }
    console.error('switch chain failed', err);
    setStatus('Please switch to Monad Testnet in your wallet.', 'error');
    return false;
  }
}

async function getProvider() {
  provider = new ethers.BrowserProvider(window.ethereum);
  return provider;
}

async function hasContractCode(addr) {
  try {
    const p = provider || await getProvider();
    const code = await p.getCode(addr);
    return !(code === '0x' || code === '0x0' || code === '');
  } catch (err) {
    console.error('getCode error', err);
    return false;
  }
}

/* ========= CONTRACT ADDRESS HANDLING ========= */
function updateContractLabel() {
  contractLabel.textContent = contractAddress || 'Not set';
}

async function setContractFromInput() {
  const raw = contractAddressInput.value.trim() || contractAddress;
  if (!raw) { setStatus('Provide a contract address first.', 'error'); return; }
  try {
    contractAddress = ethers.getAddress(raw);
  } catch (err) {
    setStatus('Invalid contract address format.', 'error');
    return;
  }
  updateContractLabel();
  // if connected, check deployed code
  if (provider) {
    const ok = await hasContractCode(contractAddress);
    if (!ok) {
      setStatus('No contract found at that address (or provider blocked).', 'error');
      contract = null;
      return;
    }
    if (!abi) {
      setStatus('ABI missing (abi.js not loaded).', 'error');
      return;
    }
    contract = new ethers.Contract(contractAddress, abi, signer || provider);
    setStatus('Contract loaded OK.', 'success');
    profileCard.classList.remove('hidden');
    skillsCard.classList.remove('hidden');
    contractLabel.textContent = contractAddress;
    contractAddressInput.value = contractAddress;
  } else {
    setStatus('Contract set locally. Connect wallet to validate on-chain.', 'muted');
    contractLabel.textContent = contractAddress;
    contractAddressInput.value = contractAddress;
  }
}

/* ========= WALLET CONNECT ========= */
async function connectWallet() {
  if (!window.ethereum) { setStatus('No injected wallet (MetaMask).', 'error'); return; }
  try {
    await window.ethereum.request({ method: 'eth_requestAccounts' });
  } catch (err) {
    setStatus('Wallet connection rejected.', 'error');
    return;
  }

  const ok = await ensureMonadNetwork();
  if (!ok) return;

  provider = new ethers.BrowserProvider(window.ethereum);
  signer = await provider.getSigner();
  try {
    signerAddress = await signer.getAddress();
  } catch (err) {
    setStatus('Failed to get signer address.', 'error');
    console.error(err);
    return;
  }

  setStatus(`Connected: ${signerAddress}`, 'success');
  connectBtn.textContent = `${signerAddress.slice(0,6)}...${signerAddress.slice(-4)}`;
  addressBadge.textContent = `${signerAddress.slice(0,6)}...${signerAddress.slice(-4)}`;

  // if contractAddress provided, validate existence
  if (contractAddress) {
    const exists = await hasContractCode(contractAddress);
    if (!exists) {
      setStatus(`No contract found at ${contractAddress} (update address).`, 'error');
      contract = null;
      updateContractLabel();
      return;
    }
    if (!abi) {
      setStatus('ABI missing (abi.js not loaded).', 'error');
      return;
    }
    contract = new ethers.Contract(contractAddress, abi, signer);
    setStatus(`Connected & contract OK (${contractAddress}).`, 'success');
    profileCard.classList.remove('hidden');
    skillsCard.classList.remove('hidden');
    // initial loads
    await loadProfile();
    await loadSkills();
  } else {
    setStatus('Connected — set contract address to continue.', 'muted');
  }
}

/* ========= IPFS UPLOAD (Infura public endpoint) ========= */
async function uploadFileToIPFS(file, onProgress) {
  // NOTE: ipfs.infura.io public API sometimes enforces CORS; if blocked run an IPFS node or use a pinning service.
  const fd = new FormData();
  fd.append('file', file);
  uploadProgress.classList.remove('hidden');
  uploadProgress.textContent = 'Uploading…';
  try {
    const res = await fetch('https://ipfs.infura.io:5001/api/v0/add', { method: 'POST', body: fd });
    if (!res.ok) throw new Error(`IPFS upload failed ${res.status}`);
    const data = await res.json();
    uploadProgress.classList.add('hidden');
    return `ipfs://${data.Hash}`;
  } catch (err) {
    uploadProgress.classList.add('hidden');
    console.error('IPFS upload error', err);
    throw err;
  }
}

/* ========= PROFILE / SKILLS ========== */
async function createProfile() {
  if (!contract) { setStatus('Contract not loaded.', 'error'); return; }
  const name = prompt('Display name (required):'); if (!name) return;
  const bio = prompt('Short bio (optional):') || '';

  // if PFP chosen -> upload
  let pfpURI = '';
  const file = pfpfInput.files && pfpfInput.files[0];
  if (file) {
    try {
      setStatus('Uploading PFP to IPFS…');
      pfpURI = await uploadFileToIPFS(file);
      setStatus('PFP uploaded, sending tx…');
    } catch (err) {
      setStatus('PFP upload failed. Cancelling.', 'error');
      return;
    }
  }

  try {
    const tx = await contract.createProfile(name, bio, pfpURI);
    setStatus('Waiting for tx confirmation…');
    await tx.wait();
    setStatus('Profile created/updated!', 'success');
    await loadProfile();
  } catch (err) {
    console.error('createProfile failed', err);
    setStatus('Profile tx failed (see console).', 'error');
  }
}

async function loadProfile() {
  if (!contract || !signerAddress) { profileDetails.innerHTML = '<div class="muted">Connect & set contract to load</div>'; return; }
  try {
    const p = await contract.profiles(signerAddress);
    if (!p || p.joinedAt?.toString() === '0') {
      profileDetails.innerHTML = '<div class="muted">No profile found — create one.</div>';
      return;
    }
    const pfpURL = p.pfpURI ? p.pfpURI.replace('ipfs://', 'https://ipfs.io/ipfs/') : '';
    profileDetails.innerHTML = `
      <div class="flex items-center gap-3">
        ${pfpURL ? `<img src="${pfpURL}" class="pfp" />` : `<div class="w-12 h-12 rounded-full bg-gray-700"></div>`}
        <div>
          <div><b>${p.displayName}</b></div>
          <div class="muted small">${p.bio || ''}</div>
          <div class="muted small">Joined: ${p.joinedAt ? new Date(Number(p.joinedAt) * 1000).toLocaleString() : 'N/A'}</div>
        </div>
      </div>
    `;
    pfpPreview.src = p.pfpURI ? p.pfpURI.replace('ipfs://', 'https://ipfs.io/ipfs/') : '';
    if (p.pfpURI) pfpPreview.classList.remove('hidden');
  } catch (err) {
    console.error('loadProfile error', err);
    setStatus('Failed to load profile (see console).', 'error');
  }
}

async function loadSkills() {
  if (!contract || !signerAddress) { skillsList.innerHTML = '<div class="muted">Connect & set contract to load skills</div>'; return; }
  try {
    const list = await contract.getSkills(signerAddress);
    skillsList.innerHTML = '';
    if (!list || list.length === 0) { skillsList.innerHTML = '<div class="muted">No skills yet.</div>'; return; }
    list.forEach((sk, idx) => {
      const el = document.createElement('div');
      el.className = 'flex justify-between items-center p-2 bg-[#061219] rounded-lg';
      const left = document.createElement('div');
      left.innerHTML = `<div class="font-medium">${sk.name}</div><div class="muted small">${sk.category}</div><a class="muted small" href="${sk.proofURI}" target="_blank">${sk.proofURI}</a>`;
      const right = document.createElement('div');
      right.innerHTML = `<div class="muted small">Cred: ${sk.credibility ? ethers.formatEther(sk.credibility) : '0'}</div>`;
      el.appendChild(left); el.appendChild(right);
      skillsList.appendChild(el);
    });
  } catch (err) {
    console.error('loadSkills error', err);
    skillsList.innerHTML = '<div class="muted">Failed to load skills (see console).</div>';
  }
}

async function addSkill() {
  if (!contract) { setStatus('Contract not loaded.', 'error'); return; }
  const name = prompt('Skill name (required):'); if (!name) return;
  const category = prompt('Category (optional):') || '';
  const proofURI = prompt('Proof URI (optional):') || '';
  try {
    const tx = await contract.addSkill(name, category, proofURI);
    setStatus('Waiting for addSkill tx...');
    await tx.wait();
    setStatus('Skill added!', 'success');
    await loadSkills();
  } catch (err) {
    console.error('addSkill failed', err);
    setStatus('Failed to add skill (see console).', 'error');
  }
}

/* ========= LOAD OTHER BUILDER & ENDORSE ========= */
async function loadBuilderSkills() {
  builderSkillsList.innerHTML = '';
  const raw = builderAddressInput.value.trim();
  if (!raw) { builderSkillsList.innerHTML = '<div class="muted">Enter builder address then click Load.</div>'; return; }
  let addr;
  try { addr = ethers.getAddress(raw); } catch (err) { builderSkillsList.innerHTML = `<div class="text-red-400">Invalid address</div>`; return; }
  if (!contract) { builderSkillsList.innerHTML = '<div class="muted">Contract not loaded.</div>'; return; }
  try {
    const list = await contract.getSkills(addr);
    if (!list || list.length === 0) { builderSkillsList.innerHTML = `<div class="muted">No skills for ${addr}</div>`; return; }
    list.forEach((sk, idx) => {
      const card = document.createElement('div');
      card.className = 'flex justify-between items-center p-2 bg-[#061219] rounded-lg';
      card.innerHTML = `
        <div>
          <div class="font-medium">${sk.name}</div>
          <div class="muted small">${sk.category}</div>
          <a class="muted small" href="${sk.proofURI}" target="_blank">${sk.proofURI}</a>
        </div>
        <div class="flex flex-col items-end gap-2">
          <div class="muted small">Cred: ${sk.credibility ? ethers.formatEther(sk.credibility) : '0'}</div>
          <div>
            <button class="btn endorseBtn" data-addr="${addr}" data-id="${idx}">Endorse</button>
          </div>
        </div>`;
      builderSkillsList.appendChild(card);
    });
    // attach handlers for endorse buttons
    document.querySelectorAll('.endorseBtn').forEach(b => {
      b.onclick = async (e) => {
        const addr = e.target.dataset.addr;
        const id = Number(e.target.dataset.id);
        const amt = prompt('Enter MON to stake as endorsement (e.g. 0.01):'); if (!amt) return;
        try {
          setStatus('Sending endorsement tx...');
          const tx = await contract.endorseSkill(addr, id, { value: ethers.parseEther(amt) });
          await tx.wait();
          setStatus('Endorsement success!', 'success');
          // refresh the list for updated credibility
          await loadBuilderSkills();
        } catch (err) {
          console.error('endorse failed', err);
          setStatus('Endorsement failed (see console).', 'error');
        }
      };
    });
  } catch (err) {
    console.error('getSkills(addr) failed', err);
    builderSkillsList.innerHTML = '<div class="text-red-400">Failed to load skills (see console)</div>';
  }
}

/* ========= UI: Drag & Drop PFP ========= */
fileDrop.addEventListener('click', () => pfpfInput.click());
chooseFileBtn.addEventListener('click', (e) => { e.stopPropagation(); pfpfInput.click(); });

fileDrop.addEventListener('dragover', (e) => { e.preventDefault(); fileDrop.style.borderColor = 'rgba(0,255,208,0.6)'; });
fileDrop.addEventListener('dragleave', () => { fileDrop.style.borderColor = 'rgba(255,255,255,0.04)'; });
fileDrop.addEventListener('drop', (e) => {
  e.preventDefault(); fileDrop.style.borderColor = 'rgba(255,255,255,0.04)';
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) { pfpfInput.files = e.dataTransfer.files; previewFile(f); }
});

pfpfInput.addEventListener('change', () => {
  const f = pfpfInput.files && pfpfInput.files[0]; if (f) previewFile(f);
});

function previewFile(file) {
  const reader = new FileReader();
  reader.onload = (ev) => {
    pfpPreview.src = ev.target.result;
    pfpPreview.classList.remove('hidden');
  };
  reader.readAsDataURL(file);
}

/* ========= BIND UI ========= */
connectBtn.onclick = connectWallet;
setContractBtn.onclick = setContractFromInput;
createProfileBtn.onclick = createProfile;
refreshProfileBtn.onclick = loadProfile;
addSkillBtn.onclick = addSkill;
loadBuilderBtn.onclick = loadBuilderSkills;
clearBuilderBtn.onclick = () => { builderAddressInput.value = ''; builderSkillsList.innerHTML = ''; };

/* ========= INIT ========= */
(async function init() {
  // preload contract address input if default provided
  if (DEFAULT_CONTRACT_ADDRESS) {
    contractAddressInput.value = DEFAULT_CONTRACT_ADDRESS;
    contractAddress = DEFAULT_CONTRACT_ADDRESS;
    updateContractLabel();
  } else {
    contractLabel.textContent = 'Not set';
  }
  setStatus('Ready — set contract and connect wallet.');
})();
</script>
</body>
</html>
